---
title: "Bluetooth Low Energy: подробный гайд для начинающих"
source: "https://habr.com/ru/articles/532298/"
author:
  - "[[Егор Марков]]"
published: 2020-12-10
created: 2026-01-30
description: "Создание кастомного сервиса и тем более клиента Bluetooth Low Energy – прогулка по граблям с завязанными глазами. По крайне мере так было для меня 4 года назад, когда я только начинал работать с..."
tags:
  - "clippings"
---
[Автор оригинала: Mohammad Afaneh](https://www.novelbits.io/introduction-to-bluetooth-low-energy-book/)

Создание кастомного сервиса и тем более клиента Bluetooth Low Energy – прогулка по граблям с завязанными глазами. По крайне мере так было для меня 4 года назад, когда я только начинал работать с BLE-устройствами. Сейчас почти каждый мой проект предусматривает использование этого протокола, поэтому в свое время пришлось в нем долго и мучительно разбираться.

Разложить все по полкам помогла книга Мохаммада Афане ["Intro to Bluetooth Low Energy"](https://www.novelbits.io/introduction-to-bluetooth-low-energy-book/) и серия постов на [Novel Bits](https://www.novelbits.io/). Лично для меня эта книга стала настоящим открытием. Изначально я делал ее перевод на русский для своих коллег, не имеющим опыт работы с BLE. С согласия автора (огромное ему спасибо) решил опубликовать свою работу здесь. Надеюсь, перевод окажется полезным.

Это первая часть перевода (всего их будет 5), которая рассказывает, что такое BLE, его возможности и отличия от Bluetooth Classic, а также описывает архитектуру протокола.

![](https://habrastorage.org/r/w780/getpro/habr/upload_files/d29/de6/216/d29de6216628ea7c5a500f4ca55f98f4.jpg)

#### Об авторе

Мохаммад Афане занимается разработкой встроенного программного обеспечения и прошивок с 2006 года. Он работал и консультировал множество крупных компаний, включая такие как Allegion (Schlage locks), Motorola, Technicolor, Audiovox, и Denon & Marantz Group. На протяжении всей своей карьеры он работал над множеством проектов Интернета Вещей, включая: беспроводные электронные дверные замки, спутниковые приемники, беспроводные дверные замки и т.д.

В июле 2015 года он принял решение прекратить работу на полную ставку для того, чтобы основать собственную компанию [Novel Bits, LLC](https://www.novelbits.io/), где он делится своими знаниями и опытом на своем web-сайте, локальных тренингах и в электронных книгах, посвященных разработке приложений с поддержкой Bluetooth Low Energy.

Вы можете связаться с Мохаммадом по его электронной почте: mohammad@novelbits.io или через профиль на [LinkedIn](https://linkedin.com/in/mafaneh).

## Базовые понятия Bluetooth Low Energy

### 1\. Что такое Bluetooth Low Energy?

Bluetooth был задуман как технология связи ближнего диапазона, призванная заменить провода в таких устройствах, как компьютерные мыши, клавиатуры или персональные компьютеры. Если у вас есть современный автомобиль или смартфон, то скорее всего вы использовали Bluetooth хотя бы раз в своей жизни. Он повсюду: в громкоговорителях и колонках, беспроводных наушниках, автомобилях, носимых устройствах и даже в [шлёпанцах](https://gizmodo.com/these-flip-flops-are-smart-for-the-dumbest-possible-rea-1793730937)!

Первая официальная версия стандарта была выпущена компанией Ericsson в 1994 году. Разработчики назвали свое изобретение в честь короля Дании Харальда Гормссона по прозвищу «Синезубый», объединившего в 10 веке враждовавшие датские племена в единое королевство.

В настоящее время существует два типа устройств с поддержкой Bluetooth:

- **Bluetooth Classic (BR/EDR)**, используется в беспроводных громкоговорителях, автомобильных информационно-развлекательных системах и наушниках;
- **Bluetooth Low Energy (BLE),** т.е. Bluetooth с низким энергопотреблением, который появился в версии стандарта Bluetooth 4.0. Он чаще всего применяется в приложениях, чувствительных к энергопотреблению (например в устройствах с батарейным питанием) или в устройствах, передающих небольшие объемы данных с большими перерывами между передачами (например, разнообразные сенсоры параметров окружающей среды или управляющие устройства, такие как беспроводные выключатели).

Эти два типа устройств несовместимы друг с другом, даже если они выпущены под одним брендом или спецификацией. Устройства с поддержкой Bluetooth Classic не могут напрямую связываться с устройствами, использующими BLE. Это причина, по которой некоторые устройства, такие как смартфоны, выполняются с поддержкой обоих типов соединения (так называемые **Dual mode Bluetooth devices**), что позволяет им обмениваться информацией с обоими типами устройств.

![Рис.1: Типы Bluetooth-устройств](https://habrastorage.org/r/w780/getpro/habr/upload_files/a31/7dc/4b7/a317dc4b7dac59aab10c0e6fb11f0d51.png)

Рис.1: Типы Bluetooth-устройств

Несколько важных замечаний о BLE:

- Официальная спецификация Bluetooth сочетает оба типа Bluetooth (Classic и BLE), что иногда затрудняет поиск документации, специфичной для BLE;
- BLE был введен в версии 4.0 спецификации стандарта Bluetooth, выпущенной в 2010 году;
- BLE иногда называют Bluetooth Smart, BTLE или Bluetooth 4.0, что является ошибкой, так как эта версия в действительности включает оба типа Bluetooth;
- Bluetooth Classic и BLE работают в одном и том же частотном диапазоне – 2.4 ГГц, ISM-диапазон.

Поскольку во многих устройствах Интернета Вещей (IoT) используются небольшие устройства и датчики, BLE стал наиболее часто используемым протоколом связи (в сравнении с Bluetooth Classic) в приложениях Интернета Вещей. В декабре 2016 года группа компаний Bluetooth Special Interest Group (SIG), регулирующая развитие стандарта, выпустила Bluetooth версии 5.0 (для простоты маркетинга была убрана точка из названия, так что официально он называется Bluetooth 5). Большинство улучшений и новых функций, представленных в этой версии, были ориентированы на BLE, а не на Bluetooth Classic.

Вы также могли слышать о другом термине, связанном с Bluetooth − **Bluetooth Mesh**. Bluetooth Mesh был выпущен в июле 2017 года и основан на BLE. Для работы ему требуется полный **стек** BLE (ПО, которое действует как интерфейс для другого программного или аппаратного обеспечения), но он не является частью основной спецификации Bluetooth. Мы рассмотрим более подробно эту технологию в отдельной главе.

Подводя итог, посмотрим на диаграмму, показывающую прогресс BLE за прошедшие годы с начала его появления:

![Рис.2: История BLE](https://habrastorage.org/r/w780/getpro/habr/upload_files/40e/06f/c90/40e06fc90dab038331eac0c4486ec1ab.png)

Рис.2: История BLE

### Технические факты о BLE

Некоторые из наиболее важных технических фактов о BLE включают в себя:

- Используемый частотный диапазон **2.400 - 2.4835 ГГц.**
- Весь частотный диапазон поделен на **40** **каналов по 2 МГц каждый.**
- Максимальная скорость передачи данных по радиоканалу (начиная с Bluetooth версии 5) **2Мбит/с.**
- Дальность передачи сильно зависит от физического окружения, а также используемого режима передачи. Например, в режиме большой дальности передачи дальность связи будет выше, а скорость передачи ниже, чем в высокоскоростном режиме. Типичная дальность передачи: **10-30 метров**.
- Потребление электроэнергии также может изменяться в широких пределах. Оно зависит от реализации устройства, различных параметров протокола и используемого чипсета. Типичное потребление BLE-трансивера во время передачи данных как правило не превышает **15 мА**.
- Обеспечение безопасности **не обязательно** при обмене данными через BLE и зависит от устройства и реализации приложения разработчиком. Другими словами, существует несколько возможных для реализации уровней обеспечения безопасности.
- Для всех операций, связанных с шифрованием, BLE использует алгоритм **AES-CCM с длиной ключа 128 бит.**
- BLE предназначен для **передачи данных по каналу с низкой пропускной способностью.** Использование BLE для приложений с большим объемом часто передаваемых данных существенно увеличивает потребление электроэнергии и сводит на нет основное преимущество BLE. То есть минимизация использования радиосвязи, насколько это возможно, позволяет достичь минимального уровня потребления энергии.
- Версии Bluetooth (в части BLE) являются обратно совместимыми. Тем не менее возможности связи будут ограничены функциями более старой версии. Например, устройство с поддержкой Bluetooth 5 LE может установить связь с устройством с поддержкой Bluetooth 4.1 LE, но возможности, появившиеся в версии 4.2 и более новых, будут недоступны. В то же время они смогут использовать возможности подключения, рассылки и приема широковещательных пакетов, обнаруживать сервисы и характеристики, а также читать и записывать их независимо от поддерживаемой ими версии стандарта, так как эти возможности доступны во всех версиях Bluetooth.

### Сравнение Bluetooth Classic и BLE

Важно помнить, что существует большая разница между классическим Bluetooth и Bluetooth с низким энергопотреблением с точки зрения технических спецификаций, реализации и типов приложений, для которых они предназначены. Это в дополнение к тому факту, что они **несовместимы** друг с другом.

Некоторые из упомянутых различий представлены в этой таблице:

**Таблица 1**. Сравнение Bluetooth Classic и BLE

| **Bluetooth Classic** | **BLE** |
| --- | --- |
| Используется для потоковых приложений, таких как трансляция аудио и передача файлов | Используется в сенсорах, управлении устройствами и приложениях, не требующих передачи больших объемов данных |
| Не оптимизирован для низкого энергопотребления, но поддерживает большую скорость передачи (максимум 3 МБит/с, в то время как BLE 5 имеет максимум 2 МБит/с) | Предназначен для применения в малопотребляющих устройствах с большими интервалами между передачей данных |
| Использует 79 радиоканалов | Использует 40 радиоканалов |
| Обнаружение происходит на 32 каналах | Обнаружение происходит на 3 каналах, что приводит к более быстрому обнаружению и установке соединения по сравнению с Bluetooth Classic |

С момента официального выпуска в 2010 году BLE прошел череду ревизий и изменений. Наиболее важное изменение произошло в декабре 2016 года с внедрением Bluetooth 5, который привнес множество важных улучшений в спецификацию стандарта, большинство из которых касалось BLE. Эти улучшения позволили удвоить скорость передачи, в 4 раза увеличить дальность передачи и в 8 раз увеличить размер широковещательного пакета.

### Возможности и ограничения BLE

Каждая технология имеет свои ограничения, и BLE не является исключением. Как мы упомянули ранее, BLE наилучшим образом подходит для приложений с небольшим радиусом передачи и редко передаваемыми небольшими объемами данных.

#### 4.1. Ограничения BLE

#### Пропускная способность

Пропускная способность BLE ограничена физической пропускной способностью радиоканала, т.е. скоростью, с которой данные передаются по радиоканалу. Пропускная способность зависит от используемой версии Bluetooth. Для Bluetooth 4.2 и более ранних, доступна только пропускная способность в 1 Мбит/с. В Bluetooth 5 и более поздних версиях пропускная способность зависит от выбранного режима **PHY** (Physical Layer, рассматривается в разделе физического уровня). Она может составлять 1 Мбит/с как в более ранних версиях или 2 Мбит/с при использовании высокоскоростной передачи. При использовании функции дальней связи пропускная способность ограничена значениями 500 или 125 кбит/с. Мы обсудим это более подробно в главе, посвященной Bluetooth 5.

Скорость передачи с точки зрения конечного пользователя всегда будет ниже скорости передачи по радиоканалу в силу следующих факторов:

- Промежутки между пакетами данных: спецификация Bluetooth определяет зазор в 150 микросекунд между передаваемыми пакетами как требование для соблюдения спецификации. В этот промежуток времени невозможна передача данных между устройствами.
- Служебная информация внутри пакета: каждый пакет содержит помимо полезной нагрузки заголовок и служебные данные, обрабатываемые на уровнях ниже уровня приложения. Они учитываются при передаче данных, но не используются вашим приложением.
- Требование на передачу служебной информации периферийным устройством: спецификация требует обязательного ответа ведомого устройства на каждый пакет, переданный ведущим. В случае, когда необходимая для передачи информация отсутствует, передается пустой пакет.
- Переотправка пакетов данных: в случае потери пакета или перекрестных помех от находящихся поблизости устройств, потерянные или поврежденные данные отправляются заново.

#### Дальность передачи

BLE был разработан для применения на коротких расстояниях, и, следовательно, его диапазон действия ограничен. Вот некоторые факторы, ограничивающие дальность передачи при помощи BLE:

- На передачу в ISM-диапазоне 2.4 ГГц сильно влияют окружающие нас препятствия, такие как металлические предметы, бетонные стены, вода и человеческие тела.
- Диаграмма направленности и коэффициент усиления антенны.
- Корпус устройства, в котором находится антенна, также ухудшает характеристики антенны.
- Ориентация устройства в пространстве, от которого зависит ориентация антенны, например в смартфонах.

#### Потребность в шлюзе для интернет-соединения

Для передачи данных с устройства, поддерживающего только BLE-соединение, необходимо другое устройство с поддержкой как BLE, так и IP-соединения. Именно оно будет получать данные и отправлять их в интернет.

#### 4.2 Преимущества BLE

Даже с учетом представленных выше ограничений BLE имеет некоторые существенные преимущества перед другими аналогичными технологиями передачи данных для IoT.

Вот некоторые из них:

- **Меньшее энергопотребление;**

По сравнению с другими низкопотребляющими технологиями передачи данных, BLE потребляет гораздо меньше электроэнергии. Это достигается благодаря глубокой оптимизации протокола, выключению передатчика при первой возможности и пересылке малых объемов данных на низкой скорости.

- **Бесплатный доступ к официальным спецификациям;**

Чтобы получить доступ к спецификациям большинства других протоколов вы должны стать членом официальной группы или консорциума по этому стандарту. Стать членом можно за внушительную сумму (от 7500 до 35000 долларов в год). В случае с BLE, спецификации для основных версий (4.0, 4.1, 4.2, 5) доступны для загрузки с сайта [Bluetooth](https://www.bluetooth.com/) абсолютно бесплатно.

- **Низкая цена модулей и чипсетов по сравнению с другими технологиями;**
- Наконец, не менее важный фактор – **наличие в большинстве смартфонов на рынке**. Возможно, это наибольшее преимущество BLE перед такими технологиями как ZigBee, Z-Wave и Thread.

#### 4.3 Наиболее подходящие области применения BLE

Исходя из ограничений и преимуществ, указанных выше, существуют варианты использования, где BLE раскрывается наиболее полно:

- **Малый объем передаваемых данных;**

BLE подходит для случаев, когда устройство передает небольшие объемы данных, например, данные датчиков или команды исполнительных устройств.

- **Настройка устройств;**

В случаях, когда BLE не удовлетворяет основным требованиям системы, он может использоваться для настройки устройства до того, как оно окажется подключенным к основной сети передачи данных.

Например, некоторые устройства с поддержкой WiFi добавляют BLE как вспомогательный протокол вместо использования таких технологий как WiFi Direct. Это технология, которая позволяет двум устройствам с поддержкой WiFi соединяться напрямую, минуя роутер. Вы можете узнать подробнее о ней на Википедии или [здесь](https://www.wi-fi.org/discover-wi-fi/wi-fi-direct).

- **Использование смартфона в качестве интерфейса;**

Компактные малопотребляющие устройства обычно не имеют больших экранов и зачастую отображают ограниченное количество данных конечному пользователю,например, путем светодиодной индикации. В настоящее время, благодаря широкому распространению смартфонов, BLE может предложить альтернативный, гораздо более информативный и удобный интерфейс для этих устройств. Еще одним преимуществом смартфона является возможность загрузки данных в облако.

- **Персональные и носимые устройства;**

Для случаев, когда устройство является носимым и находится вне зоны покрытия беспроводных сетей (таких как WiFi или сотовая связь), BLE может оказаться единственным доступным способом подключения.

- **Устройства без возможности установления соединения.**

Вероятно вы слышали или видели ранее такие устройства как **маячки.** У этих устройств одна простая задача – выдавать через определенные промежутки времени в эфир данные так, чтобы другие устройства могли их обнаружить и принять передаваемые данные. Существуют и другие технологии, которые могут быть использованы для этих целей. Тем не менее BLE становится все более популярным, так как большинство людей имеют смартфоны, которые поддерживают BLE «из коробки».

Все вышеперечисленные сценарии только выигрывают от использования BLE. С другой стороны, есть условия, при которых, как правило, использование BLE невозможно или не дает ощутимых преимуществ, такие как:

- Потоковая передача видео;
- Трансляция высококачественного звука (*прим.: стала возможна в BLE 5.2);*
- Передача больших объемов данных в течении длительного времени в тех случаях, когда важно сокращение энергопотребления.

### Архитектура BLE

Рисунок ниже иллюстрирует различные уровни, присущие архитектуре BLE. Три главных блока в этой архитектуре – **приложение, хост** и **контроллер.**

![Рис.3: Архитектура BLE](https://habrastorage.org/r/w780/getpro/habr/upload_files/9b5/e56/cb4/9b5e56cb4138cf6461d0dac61d14e5e5.png)

Рис.3: Архитектура BLE

В этой книге мы сфокусируемся на верхних уровнях архитектуры, кратко ознакомившись с нижними уровнями в этой главе. Подробное описание верхних уровней **– GAP (Generic Access Profile), GATT (Generic Attribute Profile) и Security Manager –** вынесем в отдельные главы.

#### Прикладной уровень

Прикладной уровень зависит от варианта использования девайса/приложения и относится к реализации на основе общего профиля доступа (GAP) и общего профиля атрибутов (GATT) – он отвечает за то, как ваше приложение обрабатывает данные, полученные от других устройств и отправленные на них, а также управляющую логику.

Эта часть является кодом, который вы написали для своего приложения и, как правило, не является частью BLE-стека для платформы, под которую вы разрабатываете. Эта часть не рассматривается в книге, поскольку она зависит от специфики вашего приложения и способа использования.

#### Хост-уровень

**Хост** включает следующие уровни:

- Общий профиль доступа (GAP, Generic Access Profile);
- Общий профиль атрибутов (GATT, Generic Attribute Profile);
- Протокол атрибутов (ATT, Attribute Protocol);
- Менеджер безопасности (SM, Security Manager);
- Протокол управления и адаптации логических связей (L2CAP, Logical Link Control and Adaptation Protocol);
- Интерфейс хост-контроллера (HCI, Host Controller Interface), зона ответственности хоста.

#### Контроллер

**Контроллер** включает следующие уровни:

- Физический уровень (PHY, Physical Layer);
- Слой связи (Link Layer);
- Режим прямого тестирования (DTM, Direct Test Mode);
- Интерфейс хост-контроллера (HCI, Host Controller Interface), зона ответственности контроллера.

### Уровни архитектуры BLE

#### Физический уровень (PHY)

**PHY** относится к части оборудования, ответственного за прием, передачу, модуляцию и демодуляцию сигнала. BLE работает в ISM-диапазоне (2.4 ГГЦ), который разделен на 40 каналов по 2 Мгц, как показано на рисунке ниже:

![Рис.4: Частотный спектр и радиоканалы в BLE](https://habrastorage.org/r/w780/getpro/habr/upload_files/55b/aa6/3b5/55baa63b563af1ec0d60792cb6f97efd.png)

Рис.4: Частотный спектр и радиоканалы в BLE

Три выделенных канала носят название **Первичных Широковещательных Каналов**, в то время, как оставшиеся 37 используются в роли **Вторичных Широковещательных** и для передачи данных во время соединения. Мы подробно рассмотрим принципы их использования в разделе **“Адвертайзинг и сканирование”**, но для начала кратко ознакомимся с ними в этой главе.

**Адвертайзинг** заключается в рассылке **широковещательных пакетов** по трем **Первичным Каналам Адвертайзинга** (или части из них). Это дает возможность обнаружить широковещающее устройство и прочитать его данные сканирующим устройствам. После этого **сканирующее устройство** может инициировать **соединение,** если **широковещающее** разрешает подключение. Также сканирующее устройство может послать **запрос на сканирование,** и, если широковещающее устройство поддерживает эту функцию, то оно пошлет **ответ на сканирование**. Запросы на сканирование и ответы на него позволяют передавать дополнительные данные без подключения к устройству.

Вот некоторые другие важные технические детали, касающиеся физического уровня передачи BLE:

- Он использует скачкообразную перестройку несущей частоты (FHSS, Frequency Hopping Spread Spectrum), что позволяет двум взаимодействующим устройствам переключаться на случайные предварительно согласованные частоты для обмена данными. Это значительно повышает надежность и позволяет устройствам избегать перегруженных каналов.
- Мощность передачи может быть:

**Не более:** 100 мВт (+20 дБм) для версии 5 и более новых, 10 мВт (+10 дБм) для версии 4.2 и более старых;

**Не менее:** 0.01 мВт (-20 дБм).

- В старых версиях Bluetooth (4.0, 4.1 и 4.2) была доступна только одна скорость передачи – 1 Мбит/с. Физический уровень радио (PHY) в этом случае называется 1M PHY и является обязательным во всех версиях, включая Bluetooth 5. В Bluetooth 5 были также введены два новых дополнительных PHY:
	- **2 Мбит/с PHY, используемый для удвоения скорости передачи по сравнению с более ранними версиями Bluetooth.**
	- **Кодированный PHY, используемый для связи на дальних расстояниях.**

Мы рассмотрим эти два новых PHY и концепцию кодирования в главе, посвященной Bluetooth 5.

#### Канальный уровень

**Канальный уровень** отвечает за взаимодействие с физическим уровнем радио и предоставление другим уровням абстракции для взаимодействия с радио (через промежуточный уровень **интерфейса хост-контроллера**, который мы вскоре обсудим). Он отвечает за управление состоянием радио и соблюдение требований к временным задержкам, необходимых для удовлетворения спецификации BLE. Также он отвечает за управление аппаратно-ускоренными операциями, такими как вычисление контрольных сумм, генерацию случайных чисел и шифрование.

Существует три основных состояния, в которых может находиться устройство с BLE:

- Широковещательное состояние (Advertising);
- Состояние сканирования (Scanning);
- Подключенное состояние.

Когда устройство посылает широковещательные пакеты, оно позволяет сканирующим устройствам обнаружить себя и **подключиться**. Если широковещающее устройство допускает подключения, сканирующее устройство нашло его и послало запрос на подключение, оба они переходят в **подключенное** состояние.

Канальный уровень управляет различными состояниями радио, показанными на рисунке:

![Рис.5: Состояния канального уровня](https://habrastorage.org/r/w780/getpro/habr/upload_files/ef9/6c7/644/ef96c76443122394faa6c299902a61d0.png)

Рис.5: Состояния канального уровня

- **Standby:** состояние по умолчанию, когда радио не передает и не принимает никаких данных.
- **Advertising:** состояние, в котором устройство посылает широковещательные пакеты для обнаружения и чтения другими устройствами.
- **Scanning:** состояние, в котором устройство ищет устройства, посылающие широковещательные пакеты.
- **Initiating:** состояние, в котором начинается процесс установки соединения с устройством, находящимся в состоянии advertising.
- **Connected:** Состояние, в котором одно устройство установило соединение с другим и регулярно обменивается с ним информацией. В подключенном состоянии устройство, которое находилось в состоянии scanning и инициировало соединение, называется ведущим. Устройство, которое рассылало широковещательные пакеты, называется ведомым.

Мы рассмотрим эти состояния более подробно в последующих главах.

Bluetooth адрес:

Bluetooth-устройства идентифицируются посредством 48-битного адреса, похожего на MAC-адрес. Существуют два основных типа адресов: **публичный** и **случайный.**

Публичный адрес:

Это фиксированный адрес, запрограммированный на фабрике. Он не может быть изменен и должен быть зарегистрирован в IEEE (также, как и MAC-адреса устройств с поддержкой WiFi или Ethernet).

Случайный адрес:

Так как у производителей есть возможность выбирать, какой тип адреса использовать (публичный или случайный), случайные адреса встречаются более часто, так как они не требуют регистрации в [Институте инженеров электротехники и электроники](https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%81%D1%82%D0%B8%D1%82%D1%83%D1%82_%D0%B8%D0%BD%D0%B6%D0%B5%D0%BD%D0%B5%D1%80%D0%BE%D0%B2_%D1%8D%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%BE%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D0%BA%D0%B8_%D0%B8_%D1%8D%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%BE%D0%BD%D0%B8%D0%BA%D0%B8). Случайный адрес программируется на устройстве или генерируется в ходе выполнения программы. Он может относиться к одному из следующих подтипов:

- ***Статический адрес***
	- Используется в качестве замены публичного адреса;
	- Может быть заново сгенерирован при загрузке кода или оставаться постоянным в течение всего срока службы;
	- Не может изменяться при включении или выключении.
- ***Частный адрес*** включает в себя следующие подтипы:
	– Неразрешимый частный адрес:
	- Случайный, генерируется на определенный промежуток времени;
	- Широко не используется.
	– Разрешимый частный адрес:
	- Используется для обеспечения безопасности;
	- Генерируется с использованием ключа (IRK, Identity Resolving Key) и случайного числа;
	- Периодически меняется (даже во время соединения);
	- Используется для защиты от отслеживания злоумышленниками;
	- Доверенные устройства (**связанные**, описанные в главе, посвященной безопасности) могут расшифровать адрес, используя предварительно сохраненный ключ.

#### Режим прямого тестирования

Режим прямого тестирования (DTM, Direct Test Mode) используется исключительно для проведения испытаний радиочасти во время производства или сертификационных испытаний. Он не относится напрямую к теме нашей книги, поэтому мы оставим его без подробного рассмотрения.

#### Уровень интерфейса хост-контроллера (HCI)

**Интерфейс хост-контроллера –** это стандартный протокол, определенный спецификацией Bluetooth, который позволяет уровню **хоста** коммуницировать с уровнем **контроллера**. Эти уровни могут быть реализованы на двух раздельных микросхемах или существовать на одной. В этом смысле он также обеспечивает взаимодействие между микросхемами, поэтому разработчик устройства может выбрать два сертифицированных Bluetooth-устройства, контроллер и хост, и быть на 100% уверенным в том, что они совместимы друг с другом в плане связи между уровнями хоста и контроллера.

В случае, когда хост и контроллер находятся на разных микросхемах, связь между ними может быть реализована посредством трех официально поддерживаемых физических интерфейсов: UART, USB или [SDIO (Secure Digital Input Output)](https://wiki.freebsd.org/SDIO). В случае, когда хост и контроллер находятся на одной и той же микросхеме, интерфейс хост-контроллера будет логическим интерфейсом.

Задача интерфейса хост-контроллера состоит в передаче команд от хоста контроллеру и передаче информации и событий от контроллера к хосту. На рисунке ниже приведен пример обмена командами и событиями между уровнями хоста и контроллера.

![Рис.6: Пример пакетов интерфейса хост-контроллера](https://habrastorage.org/r/w780/getpro/habr/upload_files/44f/9ba/3a2/44f9ba3a260a88301063ae347586937e.png)

Рис.6: Пример пакетов интерфейса хост-контроллера

Примеры сообщений включают в себя: пакеты команд, настройку контроллера, запрос действий, управление параметрами соединения, пакеты событий, завершение команд и события состояния.

#### Уровень протокола управления и адаптации логического канала (L2CAP)

**Протокол L2CAP** предоставляет услуги по работе с данными, как ориентированные на соединения, так и без ориентации на них, протоколам более высокого уровня с возможностями мультиплексирования и обеспечения операций по сегментации и обратной сборке. Он заимствован из стандарта Bluetooth Classic и в случае BLE выполняет следующие задачи:

- Принимает несколько протоколов с верхних уровней и помещает их в стандартные пакеты BLE, которые передаются на нижние уровни под ним.
- Управляет фрагментацией и рекомбинацией пакетов. Он берет большие пакеты с верхних уровней и разбивает их на порции, которые соответствуют максимальному размеру полезной нагрузки BLE, поддерживаемому для передачи. На стороне получателя он принимает несколько пакетов и объединяет их в один пакет, который может быть обработан верхними уровнями.

В случае BLE уровень L2CAP управляет двумя основными протоколами: протоколом атрибутов (ATT, рассмотрен в главе, посвященной GATT) и протоколу управления безопасностью (SMP, рассмотрен в главе, посвященной безопасности).

#### Слои верхнего уровня

Протокол атрибутов (АТТ), общий профиль атрибутов (GATT), менеджер безопасности (SM) и общий профиль доступа (GAP) будут подробно рассмотрены в следующих главах.

---

На этом заканчивается первая глава книги. Большое спасибо дочитавшим. Следующая часть будет посвящена классам устройств и адвертайзингу – методу, с помощью которого устройства сообщают о своем присутствии окружающему миру.

