---
title: "Bluetooth Low Energy: подробный гайд для начинающих. Часть 2"
source: "https://habr.com/ru/articles/533580/"
author:
  - "[[Егор Марков]]"
published: 2020-12-17
created: 2026-01-30
description: "Это вторая часть перевода книги Мохаммада Афане “Intro to Bluetooth Low Energy”. В представленных главах мы поговорим о типах устройств и об адвертайзинге, методе, с помощью которого периферийные..."
tags:
  - "clippings"
---
[Автор оригинала: Mohammad Afaneh](https://www.novelbits.io/introduction-to-bluetooth-low-energy-book/)

Это вторая часть перевода книги Мохаммада Афане [“Intro to Bluetooth Low Energy”.](https://www.novelbits.io/introduction-to-bluetooth-low-energy-book/) В представленных главах мы поговорим о типах устройств и об адвертайзинге, методе, с помощью которого периферийные устройства сообщают о своем присутствии. Первая часть – [здесь.](https://habr.com/ru/post/532298/)

Хочу сразу отметить, что адвертайзинг может использоваться не только для обнаружения устройств, но и для отправки кастомных данных. Например, в портативном мониторе качества воздуха [Atmotube](https://notanotherone.com/en/atmotube#), пакеты адвертайзинга и ответа на сканирование используются для передачи сведений о текущих показаниях сенсоров. Это удобно для контроля показаний сенсоров на этапе производства и при сборе данных несколькими устройствами.

![](https://habrastorage.org/r/w780/getpro/habr/upload_files/90c/f19/266/90cf192664ac4d4d47874b86083dde2a.png)

## 2\. Периферийные и центральные устройства BLE

Существуют несколько важных определений, с которыми вы будете постоянно сталкиваться при изучении BLE. Два наиболее важных касаются ролей устройства: **BLE central** и **BLE peripheral.**

Рассмотрим их более детально.

### 2.1 Периферийные устройства

**Периферийное** устройство – устройство, которое объявляет о своем присутствии путем адвертайзинга, т.е. рассылки **широковещательных пакетов,** и принимает запросы на соединение от центральных устройств.

Другой связанный термин – **BLE-передатчик,** устройство, которое также рассылает широковещательные пакеты, но имеет одно отличие от периферийного устройства: оно не разрешает другим устройствам устанавливать с ним соединение. С другой стороны, устройство- **наблюдатель** только обнаруживает устройства, производящие процедуру адвертайзинга, но не имеет возможности инициировать соединение с ними.

Типичный пример устройства, реализующего роль передатчика – **маячок (beacon)**. Маячки – это устройства, которые передают информацию без возможности установить с ними соединение. Они очень популярны в двух сферах: розничная торговля и определение местоположения внутри помещений.

Например, некоторая сеть магазинов использует мобильное приложение, которое может обнаруживать маячки на территории магазина. Если покупатель, имеющий на своем смартфоне это же приложение, приблизится к маячку, то в приложении отобразится специальная скидка на группу товаров, связанную с маячком.

Отличить маячок от периферийного устройства можно по типу широковещательных пакетов, которые он передает. Существуют различные типы пакетов: некоторые указывают на возможность установить соединение, а другие просто указывают на наличие маячка в этом месте. Когда центральное BLE-устройство обнаруживает широковещательные пакеты другого устройства с BLE (будь оно маячком или периферийным), оно знает, может ли оно начинать процедуру установки соединения или нет в зависимости от типа принятых широковещательных пакетов.

Как только периферийное устройство подключается к центральному, оно принимает на себя роль **ведомого.** Центральное устройство в таком случае называется **ведущим**. Это роли, определенные на канальном уровне, тогда как роли периферийного и центрального устройства определены на уровне GAP.

### 2.2 Центральные устройства

**Центральное** устройство – устройство, которое обнаруживает периферийные устройства и считывает передаваемую ими информацию. Оно также может устанавливать соединение с одним или несколькими устройствами одновременно.

**Наблюдатель** – устройство, схожее по функционалу с центральным, но не имеющее возможности устанавливать соединение с другим устройством.

### 2.3 Сравнение типов устройств

Рассмотрим возможности и ограничения четырех типов устройств: передатчик, наблюдатель, периферийное и центральное устройство.

| **Передатчик** | **Периферийное устройство** | **Наблюдатель** | **Центральное устройство** |
| --- | --- | --- | --- |
| Не требует наличия приемника | Требует наличия как приемника, так и передатчика | Не требует наличия передатчика | Требует наличия как приемника, так и передатчика |
| Не поддерживает двунаправленный обмен данными | Поддерживает двунаправленный обмен данными | Не поддерживает двунаправленный обмен данными | Поддерживает двунаправленный обмен данными |
| Упрощенная схема, уменьшенный размер программного стека BLE | Требует полного программного стека BLE | Упрощенная схема, уменьшенный размер программного стека BLE | Требует полного программного стека BLE |

**Табл. 1:** Сравнение типов устройств

### 2.4 Энергопотребление и требования к вычислительной мощности

Протокол BLE асимметричен. Большая часть тяжелой работы, связанной с управлением соединениями, управлением временем и обработкой информации, лежит на центральном устройстве. Это помогает снизить энергопотребление и требования к вычислительной мощности периферийного устройства, что позволяет интегрировать BLE в компактные устройства с ограниченными ресурсами, например, устройства с батарейным или аккумуляторным питанием.

Центральное устройство BLE также может иметь батарейное питание, но обычно имеет перезаряжаемый аккумулятор большой емкости. Как правило, роль центрального устройства на себя берет смартфон, компьютер или планшет.

Центральное устройство может быть подключено к нескольким периферийным одновременно. Характерный пример – смартфон, подключенный к умным часам, термостату умного дома и фитнес-трекеру одновременно.

### 2.5 Многоролевые устройства BLE

В некоторых случаях поддержка BLE-устройством центральной и периферийной роли одновременно приносит заметную пользу. Например, устройство может контролировать несколько датчиков (периферийных устройств) и в то же время иметь возможность передавать данные с этих датчиков на смартфон, обеспечивая доступ к ним из интерфейса мобильного приложения.

![Рис. 1: Смартфон в качестве многоролевого устройства](https://habrastorage.org/r/w780/getpro/habr/upload_files/e60/6ec/c8d/e606ecc8d22ae7ec90bd4feecf432f31)

Рис. 1: Смартфон в качестве многоролевого устройства

### 2.6 Роль смартфонов в BLE

Одним из наиболее значимых преимуществ BLE перед другими похожими малопотребляющими технологиями, такими как ZigBee, Z-Wave, Thread и др.,) является его наличие в большинстве смартфонов, представленных на рынке. Практически все смартфоны уже имели на борту Bluetooth Classic с самых ранних дней, и большинство производителей чипсетов Bluetooth теперь внедряют в свои чипы поддержку и BLE, и Bluetooth Classic. В результате в настоящее время подавляющее большинство смартфонов поддерживает BLE.

Для смартфона возможность взаимодействовать с устройствами BLE дает пару существенных преимуществ:

- Смартфоны предоставляют пользователям привычный интерфейс. Использование мобильного приложения для взаимодействия с BLE-устройством зачастую оказывается удобнее непосредственного взаимодействия с этим устройством.
- Смартфоны, как правило, постоянно подключены к Интернету. Это означает, что данные, полученные с BLE-устройства, могут быть переданы в облако и сохранены для последующего анализа и обработки.

#### Сложности, связанные с BLE на смартфонах

В настоящий момент существуют две основные мобильные операционные системы: Android и iOS. Android представил встроенную поддержку BLE API в версии Android 4.3 (выпущена в июле 2012 года), в то время как iOS сделал то же самое немного раньше – в октябре 2011 года.

Важно отметить, что многое зависит от возможностей аппаратного обеспечения операционной системы. В случае с iOS, поддержку BLE имеют все устройства, начиная с iPhone 4s. Ситуация с Android гораздо сложнее. Эта операционная система работает на устройствах разных производителей с разной аппаратной конфигурацией, поэтому нет простого способа определить, какие устройства первыми начали поддерживать BLE. Эта проблема фрагментации Android представляет большую проблему при разработке приложений, использующих BLE, которые должны работать одинаково на всех существующих Android-устройствах.

## 3\. Рассылка и сканирование пакетов адвертайзинга

### 3.1 Общий профиль доступа (GAP)

Общий профиль доступа предоставляет фреймворк, который определяет способы взаимодействия BLE-устройств друг с другом. Он включает в себя следующие аспекты:

- Режимы и роли устройств;
- Обнаружение устройств: рассылка пакетов адвертайзинга, сканирование, параметры рассылки и сканирования, содержимое пакетов;
- Установка соединения: инициация, подтверждение, параметры соединения;
- Обеспечение безопасности

Реализация этого фреймворка является обязательной согласно официальной спецификации, и это то, что позволяет устройствам BLE обмениваться данными и взаимодействовать друг с другом.

Мы кратко осветили состояния сканирования и рассылки пакетов адвертайзинга BLE-устройств и упомянули, что периферийное устройство всегда запускается в состоянии рассылки пакетов адвертайзинга, даже если оно предназначено для работы в подключенном состоянии большую часть времени. Чтобы два устройства могли обнаружить друг друга, одно из них должно рассылать пакеты адвертайзинга, а другое – сканировать первичные широковещательные каналы (радиоканалы 37, 38, 39) в поисках пакетов адвертайзинга, отправленных периферийным устройством.

Если периферийное устройство поддерживает возможность подключения и центральное устройство обнаружило его, они могут установить соединение. В этой главе мы сфокусируемся на начальных состояниях периферийного и центрального устройства: **адвертайзинг** и **сканирование**.

### 3.2 Рассылка пакетов адвертайзинга

В состоянии **адвертайзинга** устройство рассылает пакеты, содержащие полезную информацию для других устройств, чтобы они приняли и обработали её. Пакеты посылаются через определенные интервалы времени, которые называются **интервалы адвертайзинга**.

В BLE существуют **40 радиоканалов**, разнесенных на 2 МГц (от центра до центра), как показано на рисунке ниже. Три канала называются **каналами первичного адвертайзинга**, в то время как оставшиеся 37 каналов используются для **вторичного адвертайзинга,** а также для передачи пакетов данных во время соединения.

![Рис. 8: Радиоканалы в BLE](https://habrastorage.org/r/w780/getpro/habr/upload_files/2d2/e30/67e/2d2e3067e15ae1dc8aae659f07c82772)

Рис. 8: Радиоканалы в BLE

**Замечание:** Так как устройство посылает пакеты адвертайзинга на одном из этих каналов и, как правило, постоянно переключается между ними, они (каналы) разнесены далеко по спектру друг от друга для того, чтобы избежать перекрестных помех между устройствами, вещающими на разных каналах. Также, расположение этих каналов на спектре выбрано таким, чтобы избежать помех от наиболее часто используемых Wi-Fi каналов.

Процесс адвертайзинга всегда начинается с посылки широковещательного пакета по трем первичным каналам адвертайзинга или части из них. Это позволяет центральным устройствам найти периферийные и прочитать и пакеты адвертайзинга. Затем центральное устройство может запустить процесс подключения, если периферийное устройство поддерживает такую возможность.

Также центральное устройство может послать **запрос на сканирование** и, если периферийное поддерживает такую возможность, оно пошлет пакет, содержащий **ответ на сканирование**. Запросы на сканирование и ответы позволяют периферийному устройству отправить дополнительные данные, которые не поместились в основной пакет адвертайзинга без установки соединения.

**Примечание:** длина первичного пакета адвертайзинга ограничена 31 байтами. Длина вторичного пакета адвертайзинга может составлять до 254 байт.

Как мы упоминали ранее, некоторые устройства (маячки) всегда остаются в состоянии адвертайзинга и не принимают запросы на подключение, в то время как другие (периферийные устройства) позволяют переход в подключенное состояние, если центральное устройство инициирует соединение.

Главное преимущество нахождения в состоянии адвертайзинга состоит в том, что множество центральных устройств могут получать данные с одного периферийного без необходимости в подключении. В то же время есть существенные недостатки, такие как отсутствие защиты данных и невозможность для периферийного устройства получать данные от центрального устройства (передача данных является однонаправленной).

![Рис. 9: Устройства, имеющие и не имеющие возможность подключения](https://habrastorage.org/r/w780/getpro/habr/upload_files/921/ccd/32d/921ccd32d164e066d2a4a2c23d38a1eb)

Рис. 9: Устройства, имеющие и не имеющие возможность подключения

### 3.3 Состояние сканирования

Центральные устройства, находясь в поиске пакетов адвертайзинга от периферийных устройств, перестраиваются между тремя первичными каналами адвертайзинга, прослушивая каждый из них в определенный момент времени. Для того, чтобы центральное устройство обнаружило периферийное, оно должно быть настроено на тот же канал, на котором в данный момент вещает периферийное. Для того, чтобы увеличить вероятность этого события и ускорить его наступление, можно изменять некоторые параметры адвертайзинга и сканирования.

Устройство, которое прослушивает каналы адвертайзинга в поисках пакетов адвертайзинга а затем посылает запросы сканирования, находится в режиме **активного сканирования**, а устройство, которое только принимает пакеты адвертайзинга, и не посылает запросов на сканирование, соответственно находится в режиме **пассивного сканирования**.

![Рис. 10: Пассивное и активное сканирование](https://habrastorage.org/r/w780/getpro/habr/upload_files/557/d84/aef/557d84aefac2bb38e2eb7a792de62bba)

Рис. 10: Пассивное и активное сканирование

### 3.4 События адвертайзинга

**Событие адвертайзинга** состоит из нескольких пакетов, отправленных по всем или нескольким из трех каналов первичного адвертайзинга (37, 38 и 39). Существует **семь** типов событий адвертайзинга (их можно рассматривать как различные типы пакетов):

- **Подключаемое и сканируемое ненаправленное событие.**

Этот тип позволяет другим устройствам принимать пакеты, посылать запросы сканирования отправителю и устанавливать с ним соединение.

- **Подключаемое ненаправленное событие.**

Позволяет другим устройствам принимать пакеты и устанавливать соединение с их отправителем.

- **Подключаемое направленное событие.**

Позволяет **определенному** устройству принимать пакеты и устанавливать соединение с отправителем

- **Неподключаемое и несканируемое ненаправленное событие.**

Позволяет всем устройствам принимать пакеты. В то же время **отклоняет** все запросы сканирования и попытки установить соединение.

- **Неподключаемое и несканируемое направленное событие.**

Позволяет **определенному** устройству принимать пакеты без возможности установить соединение или послать запрос сканирования.

- **Сканируемое ненаправленное событие.**

Дает возможность другим устройствам посылать запросы сканирования отправителю для получения дополнительного пакета данных.

- **Сканируемое направленное событие.**

Позволяет **определенному** устройству посылать запросы сканирования отправителю пакета адвертайзинга для получения дополнительного пакета данных.

### 3.5 Параметры адвертайзинга

Под **параметрами адвертайзинга** понимают:

- **Интервал адвертайзинга.**

Наиболее важный параметр из относящихся к адвертайзингу – это **интервал адвертайзинга**. Значение этого параметра может дискретно изменяться в пределах от **20 миллисекунд** до **10.24 секунд**, с шагом в **625 микросекунд**. Интервал адвертайзинга оказывает большое влияние на продолжительность работы от батареи, поэтому выбору его значения следует уделить самое пристальное внимание. Рекомендуется выбирать наибольший интервал адвертайзинга, позволяющий соблюсти баланс между скоростью обнаружения и энергопотреблением.

- **Данные адвертайзинга и ответа на сканирование.**

Давайте посмотрим на формат пакета адвертайзинга и составляющие его поля. Стоит отметить, что пакет ответа на сканирование использует такой же формат.

![Рис. 11: Формат пакета адвертайзинга (из спецификации стандарта Bluetooth 5)](https://habrastorage.org/r/w780/getpro/habr/upload_files/2a9/c93/619/2a9c936199602af2c88a72d11c8e67b7)

Рис. 11: Формат пакета адвертайзинга (из спецификации стандарта Bluetooth 5)

**Данные адвертайзинга** используют формат, аналогичный формату TLV ([Type-Length-Value](https://ru.wikipedia.org/wiki/Tag-length-value), Тип-Длина-Значение), используемому для передачи данных. Отличие состоит в том, что в пакетах адвертайзинга длина данных следует перед их типом. Данные адвертайзинга входят в состав протокольных данных (PDU, Protocol Data Unit) BLE-пакета и включает в себя:

- **Длину: длину данных, которые следуют за самим значением длины, включая тип данных и непосредственно данные.**
- **Тип данных адвертайзинга: тип данных адвертайзинга, содержащихся в этой структуре TLV.**
- **Данные адвертайзинга: непосредственно данные.**

Типы данных адвертайзинга определены в [д ополнении спецификации Bluetooth](https://www.bluetooth.org/docman/handlers/downloaddoc.ashx?doc_id=457081) (не в основном документе).

Ниже приведены одни из наиболее часто встречающихся типов данных:

- **Local Name: имя устройства, считываемое при его обнаружении другими устройствами, производящими процедуру сканирования.**
- **Tx Power Level: Мощность передачи, измеряемая в дБм.**
- **Flags: множество однобитных логических флагов (переменные, которые могут принимать одно из двух значений, истина \[1\] или ложь \[0\], включающее в себя:**
	- Limited Discoverable Mode (ограниченный режим обнаружения);
	- General Discoverable Mode (общий режим обнаружения);
	- BR/EDR Not Supported (возможность поддержки классического протокола Bluetooth);
	- Возможность одновременной поддержки классического и Low Energy Bluetooth на одном устройстве со стороны контроллера;
	- Возможность одновременной поддержки классического и Low Energy Bluetooth на одном устройстве со стороны хоста.

**Примечание:** понятия BR (Basic Rate, базовая пропускная способность) и EDR (Enhanced Data Rate, расширенная пропускная способность) относятся к Bluetooth Classic.

- **Service Solicitation: список из одного или нескольких UUID, показывающий, какие сервисы поддерживаются и представлены GATT-сервером устройства. Это помогает центральному устройству узнать о поддерживаемых периферийным устройством сервисах до установления соединения.**
- **Appearance: вид, определяет тип устройства в соответствии со спецификацией стандарта. Включает в себя такие виды как телефон, измеритель сердечного ритма, брелок для ключей и множество других.**

Если вы не можете найти вид, к которому можно было бы отнести ваше устройство, вы всегда можете оставить ему значение по умолчанию – **Неопределенный.**

### 3.6. Параметры сканирования

Существует три основных **параметра сканирования:**

- **Scan Type (тип сканирования): пассивное или активное.**
- **Scan Window (окно сканирования): определяет, длительность сканирования.**
- **Scan Interval (интервал сканирования): определяет частоту повторения сканирования.**

Центральное устройство прослушивает один из первичных каналов адвертайзинга в течении всего **окна сканирования** с периодом, равным **интервалу сканирования**, причем каждое последующее сканирование проходит на новом канале.

![Рис. 12: Параметры сканирования](https://habrastorage.org/r/w780/getpro/habr/upload_files/29d/697/baf/29d697baf85d4430dee08bb0d00abb94)

Рис. 12: Параметры сканирования

**\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_**

#### А что дальше?

В следующей статье мы рассмотрим вопросы, связанные с соединениями, а также разберемся с сервисами, характеристиками и способами работы с ними.
